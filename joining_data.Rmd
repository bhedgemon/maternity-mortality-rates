

---
title: "upload_code"
author: "ME"
date: "2025-10-08"
output: html_document
---

# Joining the data
```{r}
library(tidyverse)
library(lubridate)
```

# Load in Datasets
```{r}

mortality_race <- read.csv("mortality_race.CSV")
breast_cancer <- read.csv("breast_cancer_clean.csv")
breast_cancer_deaths <- read.csv("breast_cancer_death_clean.csv")
cervical_cancer <- read.csv("cervical_cancer_clean.csv")
cervical_cancer_deaths <- read.csv("cervical_cancer_deaths_clean.csv")
diabetes <- read.csv("diabetes_clean.csv")
heart_disease <- read.csv("heart_disease_clean.csv")
```

# Rename columns
```{r}
mortality_race <- mortality_race %>%
  rename(state = location_name)
mortality_race <- mortality_race %>%
  rename(year = year_id)
```



```{r}
mortality_total <- left_join(mortality_factors, mortality_race, by = c("state", "year"))
```

```{r}
library(dplyr)

# Calculate average maternal mortality by state and race across all years
mortality_avg <- mortality_race %>%
  group_by(state, race_group) %>%
  summarise(
    avg_mortality = mean(val, na.rm = TRUE),
    .groups = 'drop'
  )

# Check the result
head(mortality_avg)

# See how many states and races you have
mortality_avg %>%
  summarise(
    n_states = n_distinct(state),
    n_races = n_distinct(race_group)
  )
```

```{r}
library(dplyr)

# Calculate average maternal mortality by state and race across all years
mortality_avg <- mortality_race %>%
  group_by(state, race_group) %>%
  summarise(
    avg_mortality = mean(val, na.rm = TRUE),
    .groups = 'drop'
  )
```

```{r}
library(shiny)
library(leaflet)
library(dplyr)
library(maps)

# Prepare the data: Calculate average mortality by state and race
mortality_avg <- mortality_race %>%
  group_by(state, race_group) %>%
  summarise(
    avg_mortality = mean(val, na.rm = TRUE),
    .groups = 'drop'
  )

# Get state boundaries from maps package
states_map <- map("state", fill = TRUE, plot = FALSE)

# Extract state names and create a data frame
state_names <- sapply(strsplit(states_map$names, ":"), function(x) x[1])
states_data <- data.frame(
  region = unique(state_names),
  stringsAsFactors = FALSE
)

# Create a lookup table to match state names (maps uses lowercase)
# Convert your state names to lowercase for matching
mortality_avg <- mortality_avg %>%
  mutate(state_lower = tolower(state))

# UI
ui <- fluidPage(
  titlePanel("Maternal Mortality by State and Race"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("race_select", 
                  "Select Race/Ethnicity:",
                  choices = unique(mortality_avg$race_group),
                  selected = "All racial and ethnic groups"),
      
      hr(),
      
      p("This map shows the average maternal mortality ratio (deaths per 100,000 live births) 
        across all years in the dataset."),
      
      p("Click on states to see specific values.")
    ),
    
    mainPanel(
      leafletOutput("map", height = "600px"),
      br(),
      textOutput("selected_state_info")
    )
  )
)

# Server
server <- function(input, output, session) {
  
  # Reactive data based on selected race
  filtered_data <- reactive({
    mortality_avg %>%
      filter(race_group == input$race_select)
  })
  
  # Create color palette
  pal <- reactive({
    colorNumeric(
      palette = "YlOrRd",
      domain = filtered_data()$avg_mortality,
      na.color = "#808080"
    )
  })
  
  # Render the map
  output$map <- renderLeaflet({
    # Get map data
    states_map <- map("state", fill = TRUE, plot = FALSE)
    
    # Get IDs for each polygon
    IDs <- sapply(strsplit(states_map$names, ":"), function(x) x[1])
    
    # Merge with mortality data
    map_data <- data.frame(
      region = IDs,
      stringsAsFactors = FALSE
    ) %>%
      left_join(filtered_data(), by = c("region" = "state_lower"))
    
    # Create color vector
    colors <- pal()(map_data$avg_mortality)
    colors[is.na(colors)] <- "#808080"
    
    # Create labels
    labels <- paste0(
      "<strong>", tools::toTitleCase(map_data$region), "</strong><br/>",
      "Mortality Rate: ", 
      ifelse(is.na(map_data$avg_mortality), 
             "No data", 
             paste0(round(map_data$avg_mortality, 1), " per 100,000"))
    ) %>% lapply(htmltools::HTML)
    
    # Create the leaflet map
    leaflet(data = states_map) %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) %>%
      addPolygons(
        fillColor = colors,
        fillOpacity = 0.7,
        color = "white",
        weight = 2,
        label = labels,
        labelOptions = labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto"
        ),
        highlightOptions = highlightOptions(
          weight = 3,
          color = "#666",
          fillOpacity = 0.9,
          bringToFront = TRUE
        )
      ) %>%
      addLegend(
        position = "bottomright",
        pal = pal(),
        values = filtered_data()$avg_mortality,
        title = "Maternal Deaths<br>per 100,000<br>Live Births",
        opacity = 0.7
      )
  })
  
  # Update map when race selection changes
  observeEvent(input$race_select, {
    output$map <- renderLeaflet({
      # Get map data
      states_map <- map("state", fill = TRUE, plot = FALSE)
      
      # Get IDs for each polygon
      IDs <- sapply(strsplit(states_map$names, ":"), function(x) x[1])
      
      # Merge with mortality data
      map_data <- data.frame(
        region = IDs,
        stringsAsFactors = FALSE
      ) %>%
        left_join(filtered_data(), by = c("region" = "state_lower"))
      
      # Create color vector
      colors <- pal()(map_data$avg_mortality)
      colors[is.na(colors)] <- "#808080"
      
      # Create labels
      labels <- paste0(
        "<strong>", tools::toTitleCase(map_data$region), "</strong><br/>",
        "Mortality Rate: ", 
        ifelse(is.na(map_data$avg_mortality), 
               "No data", 
               paste0(round(map_data$avg_mortality, 1), " per 100,000"))
      ) %>% lapply(htmltools::HTML)
      
      # Create the leaflet map
      leaflet(data = states_map) %>%
        addProviderTiles(providers$CartoDB.Positron) %>%
        setView(lng = -98.5795, lat = 39.8283, zoom = 4) %>%
        addPolygons(
          fillColor = colors,
          fillOpacity = 0.7,
          color = "white",
          weight = 2,
          label = labels,
          labelOptions = labelOptions(
            style = list("font-weight" = "normal", padding = "3px 8px"),
            textsize = "15px",
            direction = "auto"
          ),
          highlightOptions = highlightOptions(
            weight = 3,
            color = "#666",
            fillOpacity = 0.9,
            bringToFront = TRUE
          )
        ) %>%
        addLegend(
          position = "bottomright",
          pal = pal(),
          values = filtered_data()$avg_mortality,
          title = "Maternal Deaths<br>per 100,000<br>Live Births",
          opacity = 0.7
        )
    })
  })
}

# Run the app
shinyApp(ui = ui, server = server)
```

