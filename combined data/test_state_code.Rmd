---
title: "test_state_code"
author: "ME"
date: "2025-10-27"
output: html_document
---

```{r}
library(leaflet)
library(sf)
library(htmltools)
library(dplyr)
library(shiny)

# Read the data
chlamydia <- read.csv("chlamydia_test.csv")
states <- read_sf("us-states.geojson")

# Get race columns (excluding "name" column)
race_columns <- c("White", "Black", "Hispanic", "AmericanIndian_AlaskaNative", "Asian")
  
  output$map <- renderLeaflet({
    # Merge data - left join chlamydia data with states geojson
    states_data <- states %>%
      left_join(chlamydia, by = "name")
    
    # Get the selected race column data
    selected_rate <- states_data[[input$race]]
    
    # Define bins for chlamydia rates
    bins <- c(0, 100, 200, 300, 500, 700, 1000, 1500, Inf)
    pal <- colorBin("YlOrRd", domain = selected_rate, bins = bins, na.color = "#808080")
    
    # Create labels
    labels <- sprintf(
      "<strong>%s</strong><br/>%g cases per 100,000<br/>Race: %s",
      states_data$name, 
      selected_rate,
      input$race
    ) %>% lapply(HTML)
    
    # Create map
    leaflet(states_data) %>%
      setView(-96, 37.8, 4) %>%
      addProviderTiles("CartoDB.Positron") %>%  # Using free tile provider
      addPolygons(
        fillColor = ~pal(selected_rate),
        weight = 2,
        opacity = 1,
        color = "white",
        dashArray = "3",
        fillOpacity = 0.7,
        highlightOptions = highlightOptions(
          weight = 5,
          color = "#666",
          dashArray = "",
          fillOpacity = 0.7,
          bringToFront = TRUE),
        label = labels,
        labelOptions = labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto")) %>%
      addLegend(pal = pal, values = ~selected_rate, opacity = 0.7, 
                title = paste("Chlamydia Rate<br/>per 100,000"),
                position = "bottomright")
  })
```

